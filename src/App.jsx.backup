import React from 'react';
import { QRCodeCanvas, QRCodeSVG } from 'qrcode.react';

/* ===========================
   QR Content Types & Generators
=========================== */
const QR_TYPES = {
    URL: 'url',
    TEXT: 'text',
    WIFI: 'wifi',
    VCARD: 'vcard',
    EMAIL: 'email',
    SMS: 'sms',
    TEL: 'tel',
    GEO: 'geo',
    EVENT: 'event',
};

const generateQRContent = (type, data) => {
    switch (type) {
        case QR_TYPES.URL:
            return data.url || 'https://example.com';
        case QR_TYPES.TEXT:
            return data.text || '';
        case QR_TYPES.WIFI:
            return `WIFI:T:${data.encryption || 'WPA'};S:${data.ssid || ''};P:${data.password || ''};H:${
                data.hidden ? 'true' : 'false'
            };;`;
        case QR_TYPES.VCARD:
            return `BEGIN:VCARD\nVERSION:3.0\nFN:${data.name || ''}\nTEL:${data.phone || ''}\nEMAIL:${
                data.email || ''
            }\nORG:${data.org || ''}\nURL:${data.url || ''}\nEND:VCARD`;
        case QR_TYPES.EMAIL:
            return `mailto:${data.email || ''}?subject=${encodeURIComponent(
                data.subject || '',
            )}&body=${encodeURIComponent(data.body || '')}`;
        case QR_TYPES.SMS:
            return `sms:${data.phone || ''}?body=${encodeURIComponent(data.message || '')}`;
        case QR_TYPES.TEL:
            return `tel:${data.phone || ''}`;
        case QR_TYPES.GEO:
            return `geo:${data.lat || '0'},${data.lng || '0'}?q=${encodeURIComponent(data.label || '')}`;
        case QR_TYPES.EVENT:
            return `BEGIN:VEVENT\nSUMMARY:${data.title || ''}\nDTSTART:${data.start || ''}\nDTEND:${
                data.end || ''
            }\nLOCATION:${data.location || ''}\nDESCRIPTION:${data.description || ''}\nEND:VEVENT`;
        default:
            return data.text || '';
    }
};

/* ===========================
   Color Presets
=========================== */
const COLOR_PRESETS = [
    { name: 'ƒêen/Tr·∫Øng', fg: '#000000', bg: '#FFFFFF', icon: '‚ö´' },
    { name: 'Tr·∫Øng/ƒêen', fg: '#FFFFFF', bg: '#000000', icon: '‚ö™' },
    { name: 'Xanh D∆∞∆°ng', fg: '#1E40AF', bg: '#DBEAFE', icon: 'üîµ' },
    { name: 'Xanh L√°', fg: '#166534', bg: '#DCFCE7', icon: 'üü¢' },
    { name: 'ƒê·ªè', fg: '#991B1B', bg: '#FEE2E2', icon: 'üî¥' },
    { name: 'T√≠m', fg: '#6B21A8', bg: '#F3E8FF', icon: 'üü£' },
    { name: 'Cam', fg: '#C2410C', bg: '#FFEDD5', icon: 'üü†' },
    { name: 'H·ªìng', fg: '#BE185D', bg: '#FCE7F3', icon: 'ü©∑' },
];

/* ===========================
   Small UI atoms
=========================== */
const Label = ({ children, htmlFor, hint }) => (
    <div className="mb-2">
        <label htmlFor={htmlFor} className="block text-sm font-bold text-slate-700 dark:text-slate-200">
            {children}
        </label>
        {hint && <p className="mt-1 text-xs text-slate-500 dark:text-slate-400 leading-relaxed">{hint}</p>}
    </div>
);

const Input = React.forwardRef(({ className = '', error, ...props }, ref) => (
    <input
        ref={ref}
        className={
            'w-full rounded-xl border-2 bg-white px-4 py-3 text-sm shadow-sm transition-all duration-200 ' +
            'focus:ring-4 placeholder:text-slate-400 dark:placeholder:text-slate-500 ' +
            'dark:bg-slate-800 dark:text-slate-100 ' +
            (error
                ? 'border-rose-400 focus:border-rose-500 focus:ring-rose-100 dark:border-rose-500 dark:focus:border-rose-400 dark:focus:ring-rose-900/30 '
                : 'border-slate-200 focus:border-indigo-500 focus:ring-indigo-100 dark:border-slate-700 dark:focus:border-indigo-400 dark:focus:ring-indigo-900/30 ') +
            className
        }
        {...props}
    />
));
Input.displayName = 'Input';

const Select = ({ className = '', ...props }) => (
    <select
        className={
            'w-full rounded-xl border-2 border-slate-200 bg-white px-4 py-3 text-sm shadow-sm transition-all duration-200 ' +
            'focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 ' +
            'dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100 ' +
            'dark:focus:border-indigo-400 dark:focus:ring-indigo-900/30 cursor-pointer ' +
            className
        }
        {...props}
    />
);

const Button = ({ className = '', ...props }) => (
    <button
        className={
            'w-full rounded-xl px-5 py-3 text-sm font-bold shadow-lg transition-all duration-200 ' +
            'bg-gradient-to-r from-indigo-600 to-indigo-500 text-white hover:from-indigo-700 hover:to-indigo-600 ' +
            'hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 ' +
            'focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400 ' +
            className
        }
        {...props}
    />
);

/* ===========================
   Utilities & Hooks
=========================== */
const getInitialTheme = () => {
    try {
        const saved = localStorage.getItem('theme');
        if (saved === 'dark' || saved === 'light') return saved;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    } catch {
        return 'light';
    }
};

function useLocalStorage(key, initialValue) {
    const [val, setVal] = React.useState(() => {
        try {
            const v = localStorage.getItem(key);
            return v !== null ? JSON.parse(v) : initialValue;
        } catch {
            return initialValue;
        }
    });
    React.useEffect(() => {
        try {
            localStorage.setItem(key, JSON.stringify(val));
        } catch (error) {
            // Ignore localStorage errors (e.g., quota exceeded, private browsing)
            console.warn('Failed to save to localStorage:', error);
        }
    }, [key, val]);
    return [val, setVal];
}

function useDebounced(value, delay = 200) {
    const [debounced, setDebounced] = React.useState(value);
    React.useEffect(() => {
        const t = setTimeout(() => setDebounced(value), delay);
        return () => clearTimeout(t);
    }, [value, delay]);
    return debounced;
}

function contrastRatio(hex1, hex2) {
    const toRgb = (h) => [1, 3, 5].map((i) => parseInt(h.slice(i, i + 2), 16) / 255);
    const lum = ([r, g, b]) => {
        const t = [r, g, b].map((c) => (c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)));
        return 0.2126 * t[0] + 0.7152 * t[1] + 0.0722 * t[2];
    };
    const L1 = lum(toRgb(hex1.replace('#', '')));
    const L2 = lum(toRgb(hex2.replace('#', '')));
    const [a, b] = L1 > L2 ? [L1, L2] : [L2, L1];
    return (a + 0.05) / (b + 0.05);
}

// Check if QR has proper quiet zone (margin)
function hasQuietZone(includeMargin) {
    return includeMargin;
}

// QR Scan Test using canvas
async function testQRScannable(canvas) {
    try {
        // Simple check: if canvas exists and has data, assume it's potentially scannable
        // In a real implementation, you'd use @zxing/browser here
        if (!canvas) return null;
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        // Check if there's actual QR pattern (not blank)
        let hasPattern = false;
        for (let i = 0; i < data.length; i += 4) {
            if (data[i] < 200 || data[i + 1] < 200 || data[i + 2] < 200) {
                hasPattern = true;
                break;
            }
        }

        return hasPattern ? 'success' : 'empty';
    } catch (e) {
        return 'error';
    }
}

/* ===========================
   Main App
=========================== */
export default function App() {
    /* ----- theme ----- */
    const [theme, setTheme] = useLocalStorage('theme', getInitialTheme());
    React.useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
    }, [theme]);
    const isDark = theme === 'dark';

    /* ----- QR Type & Content ----- */
    const [qrType, setQrType] = useLocalStorage('qr_type', QR_TYPES.URL);
    const [qrData, setQrData] = useLocalStorage('qr_data', {
        url: 'https://example.com',
        text: '',
        wifi: { ssid: '', password: '', encryption: 'WPA', hidden: false },
        vcard: { name: '', phone: '', email: '', org: '', url: '' },
        email: { email: '', subject: '', body: '' },
        sms: { phone: '', message: '' },
        tel: { phone: '' },
        geo: { lat: '', lng: '', label: '' },
        event: { title: '', start: '', end: '', location: '', description: '' },
    });

    /* ----- states (persisted) ----- */
    const [rawText, setRawText] = React.useState('');
    const text = useDebounced(rawText, 200);

    const [size, setSize] = useLocalStorage('qr_size', 360);
    const [level, setLevel] = useLocalStorage('qr_ecc', 'M');
    const [includeMargin, setIncludeMargin] = useLocalStorage('qr_margin', true);

    const [fgColor, setFgColor] = useLocalStorage('qr_fg', '#000000');
    const [bgColor, setBgColor] = useLocalStorage('qr_bg', '#ffffff');
    const [fgError, setFgError] = React.useState(false);
    const [bgError, setBgError] = React.useState(false);

    const [format, setFormat] = useLocalStorage('qr_fmt', 'canvas'); // 'canvas' | 'svg'

    // Logo size presets
    const [logoMode, setLogoMode] = useLocalStorage('qr_logo_mode', 'auto'); // 'auto' | 's' | 'm' | 'l' | 'custom'
    const [customLogoScale, setCustomLogoScale] = useLocalStorage('qr_logo_custom', 0.2);
    const [autoECC, setAutoECC] = useLocalStorage('qr_auto_ecc', true);
    const [showEccNotice, setShowEccNotice] = React.useState(false);

    const [logoUrl, setLogoUrl] = React.useState('');

    /* ----- logo helpers ----- */
    function scaleFromMode(mode) {
        switch (mode) {
            case 's':
                return 0.15;
            case 'm':
                return 0.22;
            case 'l':
                return 0.28;
            case 'custom':
                return customLogoScale;
            case 'auto':
            default:
                return logoUrl ? 0.2 : 0;
        }
    }

    const scale = scaleFromMode(logoMode);
    const logoPx = Math.round(size * scale);

    // Safety level
    const safety = scale === 0 ? 'none' : scale < 0.25 ? 'safe' : scale < 0.3 ? 'caution' : 'risky';

    // Auto-upgrade ECC when logo is large
    React.useEffect(() => {
        if (!autoECC || !logoUrl) return;
        if (scale >= 0.25 && level !== 'H') {
            setLevel('H');
            setShowEccNotice(true);
            setTimeout(() => setShowEccNotice(false), 3000);
        }
    }, [scale, autoECC, logoUrl, level, setLevel]);

    // Validate hex colors
    const isValidHex = (hex) => /^#[0-9A-Fa-f]{6}$/.test(hex);

    const handleFgChange = (val) => {
        setFgColor(val);
        setFgError(!isValidHex(val));
    };

    const handleBgChange = (val) => {
        setBgColor(val);
        setBgError(!isValidHex(val));
    };

    /* ----- refs ----- */
    const canvasWrapRef = React.useRef(null);
    const svgWrapRef = React.useRef(null);

    /* ----- derived props for QR ----- */
    const qrProps = React.useMemo(() => {
        const imageSettings = logoUrl
            ? {
                  src: logoUrl,
                  height: Math.round(size * scale),
                  width: Math.round(size * scale),
                  excavate: true,
              }
            : undefined;

        return {
            value: text || ' ',
            size,
            level,
            includeMargin,
            fgColor,
            bgColor,
            imageSettings,
        };
    }, [text, size, level, includeMargin, fgColor, bgColor, logoUrl, scale]);

    /* ----- download helpers ----- */
    const handleDownload = (ext) => {
        const isSVG = format === 'svg';
        const srcCanvas = !isSVG ? canvasWrapRef.current?.querySelector('canvas') : null;
        const srcSVG = isSVG ? svgWrapRef.current?.querySelector('svg') : null;
        if ((isSVG && !srcSVG) || (!isSVG && !srcCanvas)) return;

        if (!isSVG) {
            // PNG/JPG - t·∫£i tr·ª±c ti·∫øp
            const mime = ext === 'jpg' || ext === 'jpeg' ? 'image/jpeg' : 'image/png';
            const dataURL = srcCanvas.toDataURL(mime, 1.0);
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `qr-${Date.now()}.${ext}`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } else {
            // SVG - t·∫£i tr·ª±c ti·∫øp
            const xml = new XMLSerializer().serializeToString(srcSVG);
            const blob = new Blob([/^<\?xml/.test(xml) ? xml : `<?xml version="1.0"?>\n${xml}`], {
                type: 'image/svg+xml',
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qr-${Date.now()}.svg`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
    };

    /* ----- logo upload / drop ----- */
    const revokeIfBlob = (url) => {
        if (url && url.startsWith('blob:')) URL.revokeObjectURL(url);
    };

    const onPickLogo = (file) => {
        if (!file) return;
        const url = URL.createObjectURL(file);
        setLogoUrl((old) => {
            revokeIfBlob(old);
            return url;
        });
    };

    const handleFileInput = (e) => onPickLogo(e.target.files?.[0]);
    const handleDrop = (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files?.[0];
        onPickLogo(file);
    };

    React.useEffect(() => () => revokeIfBlob(logoUrl), [logoUrl]);

    /* ----- contrast badge ----- */
    const ratio = React.useMemo(() => contrastRatio(fgColor, bgColor), [fgColor, bgColor]);

    /* ----- render ----- */
    return (
        <div className="min-h-screen flex flex-col bg-gradient-to-br from-indigo-50 via-white to-purple-50 text-slate-900 transition-colors duration-500 dark:from-slate-950 dark:via-slate-900 dark:to-indigo-950 dark:text-slate-100">
            {/* Header */}
            <header className="flex-shrink-0 border-b border-indigo-100/50 bg-white/90 backdrop-blur-xl shadow-lg transition-all duration-300 dark:border-slate-800/50 dark:bg-slate-900/90">
                <div className="mx-auto flex max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
                    <div className="flex items-center gap-3 sm:gap-4">
                        <div className="flex h-10 w-10 sm:h-12 sm:w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-indigo-600 via-indigo-500 to-purple-600 shadow-xl ring-2 ring-indigo-100 dark:ring-indigo-900/50">
                            <svg
                                className="h-6 w-6 sm:h-7 sm:w-7 text-white"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth={2.5}
                                    d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
                                />
                            </svg>
                        </div>
                        <div className="hidden sm:block">
                            <h1 className="text-xl sm:text-2xl font-extrabold bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent">
                                QR Generator
                            </h1>
                            <p className="text-xs sm:text-sm text-slate-600 dark:text-slate-400 font-medium">
                                T·∫°o m√£ QR chuy√™n nghi·ªáp
                            </p>
                        </div>
                    </div>

                    {/* Dark toggle */}
                    <button
                        onClick={() => setTheme((t) => (t === 'dark' ? 'light' : 'dark'))}
                        aria-pressed={isDark}
                        aria-label="Ch·∫ø ƒë·ªô t·ªëi"
                        title="Ch·∫ø ƒë·ªô t·ªëi"
                        className="relative inline-flex h-8 w-14 sm:h-9 sm:w-16 items-center rounded-full bg-gradient-to-r from-slate-300 to-slate-200 transition-all duration-300 hover:from-slate-400 hover:to-slate-300 shadow-md hover:shadow-lg dark:from-slate-700 dark:to-slate-600 dark:hover:from-slate-600 dark:hover:to-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    >
                        <span
                            className={`inline-block h-6 w-6 sm:h-7 sm:w-7 transform rounded-full bg-white shadow-lg transition-all duration-300 flex items-center justify-center ${
                                isDark ? 'translate-x-7 sm:translate-x-8' : 'translate-x-1'
                            }`}
                        >
                            {isDark ? (
                                <svg className="h-4 w-4 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                                </svg>
                            ) : (
                                <svg className="h-4 w-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        fillRule="evenodd"
                                        d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                        clipRule="evenodd"
                                    />
                                </svg>
                            )}
                        </span>
                        <span className="sr-only">{isDark ? 'Dark' : 'Light'} mode</span>
                    </button>
                </div>
            </header>

            {/* Main */}
            <main className="flex-1 overflow-auto">
                <div className="mx-auto max-w-7xl grid grid-cols-1 lg:grid-cols-[440px_1fr] gap-4 sm:gap-6 px-4 sm:px-6 py-4 sm:py-6">
                    {/* Controls */}
                    <section className="flex flex-col rounded-2xl sm:rounded-3xl border-2 border-indigo-100 bg-gradient-to-br from-white to-indigo-50/30 shadow-2xl dark:border-slate-800 dark:from-slate-900 dark:to-slate-800/50 backdrop-blur-sm">
                        <div className="flex-shrink-0 px-4 sm:px-6 py-3 border-b-2 border-indigo-100 dark:border-slate-800 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-slate-800 dark:to-slate-800">
                            <h2 className="text-base sm:text-lg font-extrabold text-slate-900 dark:text-slate-100">
                                T√πy ch·ªânh QR Code
                            </h2>
                            <p className="text-xs text-slate-600 dark:text-slate-400 mt-0.5 font-medium">
                                T·∫°o m√£ QR chuy√™n nghi·ªáp v·ªõi logo v√† m√†u s·∫Øc
                            </p>
                        </div>

                        <div className="flex-1 overflow-y-auto px-4 sm:px-6 py-4 space-y-4">
                            {/* Content */}
                            <div className="space-y-1.5">
                                <Label htmlFor="content">N·ªôi dung</Label>
                                <Input
                                    id="content"
                                    placeholder="Nh·∫≠p URL ho·∫∑c vƒÉn b·∫£n‚Ä¶"
                                    value={rawText}
                                    onChange={(e) => setRawText(e.target.value)}
                                    spellCheck="false"
                                    autoComplete="off"
                                />
                            </div>
                            {/* Size + ECC */}
                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-1.5">
                                    <Label htmlFor="size">K√≠ch th∆∞·ªõc (px)</Label>
                                    <Input
                                        id="size"
                                        type="number"
                                        min={96}
                                        max={1024}
                                        value={size}
                                        onChange={(e) =>
                                            setSize(Math.min(1024, Math.max(96, Number(e.target.value) || 0)))
                                        }
                                    />
                                </div>
                                <div className="space-y-1.5">
                                    <Label htmlFor="ecc">M·ª©c ECC</Label>
                                    <Select id="ecc" value={level} onChange={(e) => setLevel(e.target.value)}>
                                        <option value="L">L (7%)</option>
                                        <option value="M">M (15%)</option>
                                        <option value="Q">Q (25%)</option>
                                        <option value="H">H (30%)</option>
                                    </Select>
                                </div>
                            </div>
                            {/* ECC auto notice */}
                            {showEccNotice && (
                                <div className="rounded-lg bg-indigo-50 border border-indigo-200 px-3 py-2 dark:bg-indigo-900/20 dark:border-indigo-800">
                                    <p className="text-xs text-indigo-700 dark:text-indigo-300">
                                        ‚ÑπÔ∏è Logo l·ªõn ‚Üí t·ª± chuy·ªÉn ECC H (30%)
                                    </p>
                                </div>
                            )}
                            {/* Colors */}
                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-1.5">
                                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                                        M√†u m√£
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <div className="relative flex-shrink-0">
                                            <input
                                                type="color"
                                                value={fgColor}
                                                onChange={(e) => handleFgChange(e.target.value.toUpperCase())}
                                                className="h-11 w-14 cursor-pointer rounded-lg border-2 border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all hover:scale-105"
                                            />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <Input
                                                value={fgColor}
                                                onChange={(e) => handleFgChange(e.target.value.toUpperCase())}
                                                className="font-mono text-xs uppercase tracking-tight h-11"
                                                error={fgError}
                                                placeholder="#000000"
                                            />
                                        </div>
                                    </div>
                                    {fgError && (
                                        <p className="text-xs text-rose-600 dark:text-rose-400 font-medium">
                                            ‚ö†Ô∏è Kh√¥ng h·ª£p l·ªá
                                        </p>
                                    )}
                                </div>
                                <div className="space-y-1.5">
                                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                                        M√†u n·ªÅn
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <div className="relative flex-shrink-0">
                                            <input
                                                type="color"
                                                value={bgColor}
                                                onChange={(e) => handleBgChange(e.target.value.toUpperCase())}
                                                className="h-11 w-14 cursor-pointer rounded-lg border-2 border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all hover:scale-105"
                                            />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <Input
                                                value={bgColor}
                                                onChange={(e) => handleBgChange(e.target.value.toUpperCase())}
                                                className="font-mono text-xs uppercase tracking-tight h-11"
                                                error={bgError}
                                                placeholder="#FFFFFF"
                                            />
                                        </div>
                                    </div>
                                    {bgError && (
                                        <p className="text-xs text-rose-600 dark:text-rose-400 font-medium">
                                            ‚ö†Ô∏è Kh√¥ng h·ª£p l·ªá
                                        </p>
                                    )}
                                </div>
                            </div>
                            {/* Options */}
                            <div className="rounded-2xl bg-gradient-to-br from-indigo-50 to-purple-50 p-3 dark:from-slate-800 dark:to-slate-800/50 border-2 border-indigo-100 dark:border-slate-700 shadow-inner">
                                <div className="grid grid-cols-2 gap-3">
                                    <label className="flex items-center gap-2 text-sm font-bold text-slate-700 dark:text-slate-200 cursor-pointer group">
                                        <input
                                            type="checkbox"
                                            checked={includeMargin}
                                            onChange={(e) => setIncludeMargin(e.target.checked)}
                                            className="h-4 w-4 rounded-lg border-2 border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500 cursor-pointer transition-all"
                                        />
                                        <span className="group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                                            Th√™m vi·ªÅn
                                        </span>
                                    </label>
                                </div>
                            </div>{' '}
                            {/* Format */}
                            <div className="space-y-1.5">
                                <Label>ƒê·ªãnh d·∫°ng</Label>
                                <div className="flex w-full rounded-2xl bg-gradient-to-r from-slate-100 to-slate-50 p-1 dark:from-slate-800 dark:to-slate-800/50 shadow-inner border border-slate-200 dark:border-slate-700">
                                    {[
                                        { v: 'canvas', label: 'PNG/JPG', icon: 'üñºÔ∏è' },
                                        { v: 'svg', label: 'SVG', icon: '‚ú®' },
                                    ].map(({ v, label, icon }) => (
                                        <button
                                            key={v}
                                            onClick={() => setFormat(v)}
                                            className={`flex-1 rounded-xl px-3 py-2 text-sm font-bold transition-all duration-200 ${
                                                format === v
                                                    ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg scale-105'
                                                    : 'text-slate-600 hover:text-slate-900 hover:bg-white/50 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-700/50'
                                            }`}
                                        >
                                            {icon} {label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            {/* Logo upload */}
                            <div className="space-y-2">
                                <Label hint="Logo gi·ªØa m√£ QR. ·∫¢nh PNG trong su·ªët t·ªët nh·∫•t.">Logo (t√πy ch·ªçn)</Label>
                                <Input
                                    type="file"
                                    accept="image/*"
                                    onChange={handleFileInput}
                                    className="text-xs file:mr-3 file:rounded-lg file:border-0 file:bg-indigo-50 file:px-4 file:py-2 file:text-xs file:font-semibold file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-indigo-900/30 dark:file:text-indigo-300 cursor-pointer"
                                />
                                {logoUrl && (
                                    <button
                                        onClick={() => {
                                            revokeIfBlob(logoUrl);
                                            setLogoUrl('');
                                        }}
                                        aria-label="X√≥a logo"
                                        className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 transition-colors"
                                    >
                                        üóëÔ∏è X√≥a logo
                                    </button>
                                )}
                            </div>
                            {/* Logo size presets */}
                            {logoUrl && (
                                <div className="space-y-2">
                                    <div className="flex items-center justify-between">
                                        <Label>K√≠ch th∆∞·ªõc logo</Label>
                                        <span className="text-xs text-slate-500 dark:text-slate-400">‚âà {logoPx}px</span>
                                    </div>

                                    <div className="grid grid-cols-5 gap-2">
                                        {[
                                            { v: 's', label: 'Nh·ªè' },
                                            { v: 'm', label: 'V·ª´a' },
                                            { v: 'l', label: 'L·ªõn' },
                                            { v: 'auto', label: 'Auto' },
                                            { v: 'custom', label: 'T√πy ch·ªânh' },
                                        ].map(({ v, label }) => (
                                            <button
                                                key={v}
                                                onClick={() => setLogoMode(v)}
                                                className={`rounded-lg px-2 py-2 text-xs font-medium transition ${
                                                    logoMode === v
                                                        ? 'bg-indigo-600 text-white shadow-md'
                                                        : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700'
                                                }`}
                                            >
                                                {label}
                                            </button>
                                        ))}
                                    </div>

                                    {/* Custom slider */}
                                    {logoMode === 'custom' && (
                                        <div className="mt-3 space-y-2">
                                            <input
                                                type="range"
                                                min={0.1}
                                                max={0.35}
                                                step={0.01}
                                                value={customLogoScale}
                                                onChange={(e) => setCustomLogoScale(Number(e.target.value))}
                                                className="w-full accent-indigo-600 cursor-pointer"
                                            />
                                            <div className="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                                                <span>10%</span>
                                                <span className="font-medium text-slate-700 dark:text-slate-300">
                                                    {Math.round(customLogoScale * 100)}%
                                                </span>
                                                <span>35%</span>
                                            </div>
                                        </div>
                                    )}

                                    {/* Safety badge + auto ECC */}
                                    <div className="mt-3 flex items-center justify-between rounded-lg bg-slate-50 px-3 py-2 dark:bg-slate-800">
                                        <span
                                            className={`text-xs font-semibold ${
                                                safety === 'safe'
                                                    ? 'text-emerald-600 dark:text-emerald-400'
                                                    : safety === 'caution'
                                                    ? 'text-amber-600 dark:text-amber-400'
                                                    : 'text-rose-600 dark:text-rose-400'
                                            }`}
                                        >
                                            {safety === 'safe' && '‚úì An to√†n'}
                                            {safety === 'caution' && '‚ö† C·∫©n tr·ªçng'}
                                            {safety === 'risky' && '‚ö† R·ªßi ro cao'}
                                        </span>

                                        <label className="flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                className="h-3.5 w-3.5 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                                                checked={autoECC}
                                                onChange={(e) => setAutoECC(e.target.checked)}
                                            />
                                            <span>T·ª± n√¢ng ECC</span>
                                        </label>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Download buttons */}
                        <div className="flex-shrink-0 border-t-2 border-indigo-100 dark:border-slate-800 px-6 py-3 space-y-2 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-slate-800 dark:to-slate-800/50">
                            <Button
                                onClick={() => handleDownload(format === 'svg' ? 'svg' : 'png')}
                                aria-label={`T·∫£i xu·ªëng ${format === 'svg' ? 'SVG' : 'PNG'}`}
                                title={`T·∫£i xu·ªëng ${format === 'svg' ? 'SVG' : 'PNG'}`}
                                className="py-2"
                            >
                                üì• T·∫£i {format === 'svg' ? 'SVG' : 'PNG'}
                            </Button>
                            {format === 'canvas' && (
                                <Button
                                    className="from-slate-600 to-slate-500 hover:from-slate-700 hover:to-slate-600 py-2"
                                    onClick={() => handleDownload('jpg')}
                                    aria-label="T·∫£i xu·ªëng JPG"
                                    title="T·∫£i xu·ªëng JPG"
                                >
                                    üì• T·∫£i JPG
                                </Button>
                            )}
                            {ratio < 4.5 && (
                                <div className="rounded-xl bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200 px-3 py-2 dark:from-amber-900/20 dark:to-orange-900/20 dark:border-amber-800">
                                    <p className="text-xs text-amber-800 dark:text-amber-200 mb-1.5 font-bold">
                                        ‚ö†Ô∏è T∆∞∆°ng ph·∫£n th·∫•p ({ratio.toFixed(1)})
                                    </p>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                handleFgChange('#000000');
                                                handleBgChange('#FFFFFF');
                                            }}
                                            className="flex-1 rounded-lg bg-amber-100 px-2 py-1 text-xs font-bold text-amber-900 hover:bg-amber-200 dark:bg-amber-900/40 dark:text-amber-100 dark:hover:bg-amber-800/50 transition-all"
                                        >
                                            ƒêen/Tr·∫Øng
                                        </button>
                                        <button
                                            onClick={() => {
                                                handleFgChange('#FFFFFF');
                                                handleBgChange('#000000');
                                            }}
                                            className="flex-1 rounded-lg bg-amber-100 px-2 py-1 text-xs font-bold text-amber-900 hover:bg-amber-200 dark:bg-amber-900/40 dark:text-amber-100 dark:hover:bg-amber-800/50 transition-all"
                                        >
                                            Tr·∫Øng/ƒêen
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </section>{' '}
                    {/* Preview */}
                    <section className="flex flex-col">
                        <div className="flex-shrink-0 mb-4 sm:mb-5">
                            <h2 className="text-xl sm:text-2xl font-extrabold bg-gradient-to-r from-slate-900 to-slate-700 bg-clip-text text-transparent dark:from-slate-100 dark:to-slate-300">
                                Xem tr∆∞·ªõc
                            </h2>
                            <p className="text-xs sm:text-sm text-slate-600 dark:text-slate-400 mt-1 font-medium">
                                K√©o & th·∫£ logo v√†o khung b√™n d∆∞·ªõi
                            </p>
                        </div>
                        <div className="flex items-center justify-center p-4">
                            <div
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={handleDrop}
                                className="relative flex w-full max-w-md mx-auto items-center justify-center bg-gradient-to-br from-white via-indigo-50/20 to-purple-50/20 p-6 sm:p-8 lg:p-10 ring-2 ring-indigo-200/50 shadow-2xl transition-all duration-300 hover:shadow-3xl dark:from-slate-900 dark:via-slate-800/50 dark:to-slate-900 dark:ring-slate-700/50 backdrop-blur-sm group rounded-2xl sm:rounded-3xl"
                            >
                                <div className="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 rounded-[2rem] opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                {format === 'canvas' ? (
                                    <div
                                        ref={canvasWrapRef}
                                        className="relative w-full aspect-square overflow-hidden shadow-2xl ring-2 ring-indigo-100 dark:ring-slate-700 hover:scale-105 transition-transform duration-300 rounded-2xl"
                                        style={{ maxWidth: '100%' }}
                                    >
                                        <QRCodeCanvas {...qrProps} style={{ width: '100%', height: '100%' }} />
                                    </div>
                                ) : (
                                    <div
                                        ref={svgWrapRef}
                                        className="relative w-full aspect-square overflow-hidden shadow-2xl ring-2 ring-indigo-100 dark:ring-slate-700 hover:scale-105 transition-transform duration-300 rounded-2xl"
                                        style={{ maxWidth: '100%' }}
                                    >
                                        <QRCodeSVG {...qrProps} style={{ width: '100%', height: '100%' }} />
                                    </div>
                                )}
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    );
}
